{{ if hugo.IsMultilingual }}
  {{ $currentPage := . }}
  {{ $languageOptions := slice $currentPage }}
  {{ range .Translations }}
    {{ $languageOptions = $languageOptions | append . }}
  {{ end }}
  {{ range .Site.Home.AllTranslations }}
    {{ $lang := .Language.Lang }}
    {{ if not (first 1 (where $languageOptions "Language.Lang" $lang)) }}
      {{ $languageOptions = $languageOptions | append . }}
    {{ end }}
  {{ end }}
  {{ $languageOptions = sort $languageOptions "Language.Weight" }}
  {{ $.Scratch.Set "languageOptions" $languageOptions }}
{{ end }}

<header class="site-header" id="site-header">
  <nav class="navbar">

    <div class="navbar__logo">
      <a href="{{ " /" | relLangURL }}">
        <img src='{{ (.Site.Params.logo | default "images/logo.jpg") | relURL }}' width="72" height="72"
          alt='{{ .Site.Params.company_name | default .Site.Title }}'>
      </a>
    </div>

    <nav class="navbar__menu" aria-label="Main navigation">
      {{ $current := . }}
      <ul>
        {{ range .Site.Menus.main }}
        {{ $active := or ($current.IsMenuCurrent "main" .) ($current.HasMenuCurrent "main" .) }}
        {{ $isProducts := eq .Identifier "products" }}
        <li class="{{ if .HasChildren }}has-dropdown{{ end }}{{ if $isProducts }} has-mega{{ end }}">
          <a href="{{ .URL | relLangURL }}" class="{{ if $active }}is-active{{ end }}">
            <span>{{ .Name }}</span>
            {{ if .HasChildren }}
            <svg class="dropdown-arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"
              aria-hidden="true">
              <path fill-rule="evenodd"
                d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z"
                clip-rule="evenodd" />
            </svg>
            {{ end }}
          </a>

          {{ if .HasChildren }}
          {{ if $isProducts }}
          <div class="mega-menu" aria-label="Products submenu">
            <div class="mega-menu__inner container container--wide">
              <div class="mega-menu__grid">
              {{ range .Children }}
              {{ $group := . }}
              {{ $groupActive := or ($current.IsMenuCurrent "main" $group) ($current.HasMenuCurrent "main" $group) }}
              <div class="mega-menu__group">
                {{ $groupHasUrl := $group.URL }}
                <div class="mega-menu__title-wrapper">
                  {{ if $groupHasUrl }}
                  <a href="{{ $group.URL | relLangURL }}" class="mega-menu__title {{ if $groupActive }}is-active{{ end }}">{{ $group.Name }}</a>
                  {{ else }}
                  <span class="mega-menu__title">{{ $group.Name }}</span>
                  {{ end }}
                </div>
                {{ if $group.HasChildren }}
                {{ $isStyleGroup := eq $group.Identifier "products-style" }}
                <ul class="mega-menu__list{{ if $isStyleGroup }} mega-menu__list--single{{ end }}">
                  {{ range $group.Children }}
                  {{ $itemActive := or ($current.IsMenuCurrent "main" .) ($current.HasMenuCurrent "main" .) }}
                  <li>
                    <a href="{{ .URL | relLangURL }}" class="{{ if $itemActive }}is-active{{ end }}">{{ .Name }}</a>
                  </li>
                  {{ end }}
                </ul>
                {{ end }}
              </div>
              {{ end }}
              </div>
            </div>
          </div>
          {{ else }}
          <ul class="dropdown-menu">
            {{ range .Children }}
            {{ $childActive := or ($current.IsMenuCurrent "main" .) ($current.HasMenuCurrent "main" .) }}
            <li>
              <a href="{{ .URL | relLangURL }}" class="{{ if $childActive }}is-active{{ end }}">{{ .Name }}</a>
            </li>
            {{ end }}
          </ul>
          {{ end }}
          {{ end }}
        </li>
        {{ end }}
      </ul>
    </nav>

    <div class="navbar__actions">
      {{ if hugo.IsMultilingual }}
        {{ $languageOptions := $.Scratch.Get "languageOptions" }}
        {{ $languageLabel := i18n "language_switcher_label" | default "选择语言" }}
        {{ $currentLang := $.Language.Lang }}
        <div class="lang-switcher lang-switcher--desktop" data-lang-switcher>
          <label class="sr-only" for="lang-switcher-desktop">{{ $languageLabel }}</label>
          <select id="lang-switcher-desktop" class="lang-switcher__select">
            {{ range $languageOptions }}
              <option value="{{ .RelPermalink }}" {{ if eq .Language.Lang $currentLang }}selected{{ end }}>
                {{ .Language.LanguageName }}
              </option>
            {{ end }}
          </select>
        </div>
      {{ end }}

      <button class="navbar__toggler" id="drawer-toggler" aria-label="打开菜单" aria-expanded="false" data-open-label="打开菜单" data-close-label="关闭菜单">
        <span class="toggler-bar"></span>
        <span class="toggler-bar"></span>
        <span class="toggler-bar"></span>
      </button>
    </div>
  </nav>
</header>

<div class="drawer-overlay" id="drawer-overlay"></div>
<aside class="drawer" id="drawer">
  <div class="drawer__header">
    <span class="sr-only">Menu</span>
  </div>

  <nav class="drawer__menu" aria-label="Mobile navigation" data-drawer-menu>
    {{ $current := . }}
    {{ $submenuPanels := slice }}
    <div class="drawer__panel drawer__panel--root is-active" data-drawer-panel="drawer-root">
      <ul class="drawer__list">
        {{ range .Site.Menus.main }}
        {{ $active := or ($current.IsMenuCurrent "main" .) ($current.HasMenuCurrent "main" .) }}
        {{ $panelKey := .Identifier }}
        {{ if not $panelKey }}
          {{ $panelKey = anchorize .Name }}
        {{ end }}
        {{ $panelID := printf "drawer-panel-%s" $panelKey }}
        {{ if .HasChildren }}
          {{ $submenuPanels = $submenuPanels | append (dict "panelID" $panelID "menu" .) }}
        {{ end }}
        <li class="drawer__item{{ if .HasChildren }} has-children{{ end }}">
          <a href="{{ .URL | relLangURL }}" class="drawer__link {{ if $active }}is-active{{ end }}">{{ .Name }}</a>
          {{ if .HasChildren }}
          <button type="button" class="drawer__chevron" data-submenu-target="{{ $panelID }}" aria-label="浏览{{ .Name }}子菜单">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
              <path d="M9.17 5.47a1 1 0 0 1 1.41.06l5 5.5a1 1 0 0 1 0 1.34l-5 5.5a1 1 0 1 1-1.48-1.34L13.59 12 9.1 6.81a1 1 0 0 1 .07-1.34Z" />
            </svg>
          </button>
          {{ end }}
        </li>
        {{ end }}
        {{ if and (hugo.IsMultilingual) ($.Scratch.Get "languageOptions") }}
        {{ $languageOptions := $.Scratch.Get "languageOptions" }}
        {{ $languageLabel := i18n "language_switcher_label" | default "选择语言" }}
        {{ $currentLang := $.Language.Lang }}
        <li class="drawer__item drawer__item--language">
          <div class="drawer__language" data-language-menu>
            <button type="button" class="drawer__lang-toggle" data-lang-toggle aria-expanded="false" aria-controls="drawer-language-options">
              <span>{{ $languageLabel }}</span>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                <path d="M5.47 9.22a1 1 0 0 1 1.41 0L12 14.34l5.12-5.12a1 1 0 1 1 1.41 1.42l-5.83 5.83a1.5 1.5 0 0 1-2.12 0L5.47 10.64a1 1 0 0 1 0-1.42Z" />
              </svg>
            </button>
            <div class="drawer__lang-options" id="drawer-language-options" hidden>
              <ul>
                {{ range $languageOptions }}
                <li>
                  <a href="{{ .RelPermalink }}" class="{{ if eq .Language.Lang $currentLang }}is-active{{ end }}" {{ if eq .Language.Lang $currentLang }}aria-current="true"{{ end }}>
                    {{ .Language.LanguageName }}
                  </a>
                </li>
                {{ end }}
              </ul>
            </div>
          </div>
        </li>
        {{ end }}
      </ul>
    </div>
    {{ range $submenuPanels }}
    {{ $menu := .menu }}
    <div class="drawer__panel drawer__panel--submenu" data-drawer-panel="{{ .panelID }}" hidden>
      <div class="drawer__panel-header">
        <button type="button" class="drawer__back" data-panel-back aria-label="返回一级菜单">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
            <path d="M15.53 5.47a.75.75 0 0 1 0 1.06L10.06 12l5.47 5.47a.75.75 0 0 1-1.06 1.06l-6-6a.75.75 0 0 1 0-1.06l6-6a.75.75 0 0 1 1.06 0Z" />
          </svg>
        </button>
        <h2 class="drawer__panel-title">{{ $menu.Name }}</h2>
      </div>
      <ul class="drawer__submenu-list">
        {{ range $menu.Children }}
        <li class="drawer__submenu-item{{ if .HasChildren }} has-grandchildren{{ end }}">
          <a href="{{ .URL | relLangURL }}" class="drawer__link">{{ .Name }}</a>
          {{ if .HasChildren }}
          <ul class="drawer__grandchildren">
            {{ range .Children }}
            <li><a href="{{ .URL | relLangURL }}" class="drawer__link">{{ .Name }}</a></li>
            {{ end }}
          </ul>
          {{ end }}
        </li>
        {{ end }}
      </ul>
    </div>
    {{ end }}
  </nav>

</aside>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const header = document.getElementById('site-header');
    const body = document.body;
    const bodyHiddenClass = 'header-hidden';

    // --- 1. 智能导航栏 (Smart Header) 逻辑 ---
    if (header) {
      let lastScrollY = window.scrollY;     // 上一次滚动位置
      const scrollThreshold = 72;         // 超过导航栏高度后才开始隐藏/显示
      const scrollDelta = 5;             // 滚动变化小于 5px 时不处理，防止抖动

      function handleSmartHeader() {
        const currentScrollY = window.scrollY;

        // 1. 处理 'is-scrolled' 样式 (背景/阴影变化)
        if (currentScrollY > 10) header.classList.add('is-scrolled');
        else header.classList.remove('is-scrolled');

        // 2. 处理 'is-hidden' 样式 (隐藏/显示)
        // 在页面顶部时，始终显示导航栏
        if (currentScrollY <= scrollThreshold) {
          header.classList.remove('is-hidden');
          body.classList.remove(bodyHiddenClass);
          lastScrollY = currentScrollY;
          return;
        }

        // 滚动变化不大时忽略
        if (Math.abs(lastScrollY - currentScrollY) < scrollDelta) {
          return;
        }

        // 向上滚动 (显示)
        if (currentScrollY < lastScrollY) {
          header.classList.remove('is-hidden');
          body.classList.remove(bodyHiddenClass);
        }
        // 向下滚动 (隐藏)
        else if (currentScrollY > lastScrollY) {
          header.classList.add('is-hidden');
          body.classList.add(bodyHiddenClass);
        }

        // 更新上一次滚动位置
        lastScrollY = currentScrollY;
      }

      // 使用 requestAnimationFrame 优化滚动性能
      let ticking = false;
      window.addEventListener('scroll', () => {
        if (!ticking) {
          window.requestAnimationFrame(() => {
            handleSmartHeader();
            ticking = false;
          });
          ticking = true;
        }
      });

      // 页面加载时执行一次
      handleSmartHeader();
    }

    // --- 2. 抽屉 (Drawer) 逻辑 ---
    const drawer = document.getElementById('drawer');
    const drawerToggler = document.getElementById('drawer-toggler');
    const drawerOverlay = document.getElementById('drawer-overlay');
    const drawerMenu = drawer ? drawer.querySelector('[data-drawer-menu]') : null;
    const rootPanelId = 'drawer-root';

    const panelMap = new Map();
    if (drawerMenu) {
      drawerMenu.querySelectorAll('[data-drawer-panel]').forEach((panel) => {
        const id = panel.getAttribute('data-drawer-panel');
        if (id) {
          panelMap.set(id, panel);
        }
      });
    }

    const resetLanguageMenu = () => {
      if (!drawerMenu) return;
      const langContainer = drawerMenu.querySelector('[data-language-menu]');
      if (!langContainer) return;
      const langToggle = langContainer.querySelector('[data-lang-toggle]');
      const langPanel = langContainer.querySelector('.drawer__lang-options');
      if (langToggle && langPanel) {
        langToggle.setAttribute('aria-expanded', 'false');
        langPanel.hidden = true;
        langPanel.classList.remove('is-open');
      }
    };

    const activatePanel = (panelId) => {
      const targetId = panelMap.has(panelId) ? panelId : rootPanelId;
      panelMap.forEach((panel, id) => {
        const isActive = id === targetId;
        panel.classList.toggle('is-active', isActive);
        panel.toggleAttribute('hidden', !isActive);
      });
      if (drawer) {
        drawer.setAttribute('data-active-panel', targetId);
      }
      if (targetId !== rootPanelId) {
        resetLanguageMenu();
      }
    };

    const setDrawerState = (isOpen) => {
      body.setAttribute('data-drawer-open', isOpen ? 'true' : 'false');
      if (drawerToggler) {
        drawerToggler.classList.toggle('open', isOpen);
        drawerToggler.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
        const openLabel = drawerToggler.getAttribute('data-open-label') || '打开菜单';
        const closeLabel = drawerToggler.getAttribute('data-close-label') || '关闭菜单';
        drawerToggler.setAttribute('aria-label', isOpen ? closeLabel : openLabel);
      }

      activatePanel(rootPanelId);

      if (!isOpen) {
        resetLanguageMenu();
      }
    };

    const isDrawerOpen = () => body.getAttribute('data-drawer-open') === 'true';

    if (drawerToggler) {
      drawerToggler.addEventListener('click', () => {
        setDrawerState(!isDrawerOpen());
      });
    }

    if (drawerOverlay) {
      drawerOverlay.addEventListener('click', () => setDrawerState(false));
    }

    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape' && isDrawerOpen()) {
        setDrawerState(false);
      }
    });

    if (drawerMenu) {
      drawerMenu.addEventListener('click', (event) => {
        const submenuTrigger = event.target.closest('[data-submenu-target]');
        if (submenuTrigger) {
          event.preventDefault();
          const target = submenuTrigger.getAttribute('data-submenu-target');
          activatePanel(target);
          return;
        }

        const backTrigger = event.target.closest('[data-panel-back]');
        if (backTrigger) {
          event.preventDefault();
          activatePanel(rootPanelId);
          return;
        }

        const langToggle = event.target.closest('[data-lang-toggle]');
        if (langToggle) {
          event.preventDefault();
          const controls = langToggle.getAttribute('aria-controls');
          const langPanel = controls ? document.getElementById(controls) : null;
          if (!langPanel) return;
          const expanded = langToggle.getAttribute('aria-expanded') === 'true';
          const nextState = !expanded;
          langToggle.setAttribute('aria-expanded', nextState ? 'true' : 'false');
          langPanel.hidden = !nextState;
          langPanel.classList.toggle('is-open', nextState);
          return;
        }
      });
    }

    activatePanel(rootPanelId);

    const langSwitchers = document.querySelectorAll('[data-lang-switcher] .lang-switcher__select');
    langSwitchers.forEach((select) => {
      select.addEventListener('change', () => {
        const target = select.value;
        if (target) {
          window.location.href = target;
        }
      });
    });
  });
</script>
