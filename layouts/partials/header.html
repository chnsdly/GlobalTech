<header class="site-header" id="site-header">
  <nav class="navbar">

    <div class="navbar__logo">
      <a href="{{ " /" | relLangURL }}">
        <img src='{{ (.Site.Params.logo | default "images/logo.jpg") | relURL }}' width="72" height="72"
          alt='{{ .Site.Params.company_name | default .Site.Title }}'>
      </a>
    </div>

    <nav class="navbar__menu" aria-label="Main navigation">
      {{ $current := . }}
      <ul>
        {{ range .Site.Menus.main }}
        {{ $active := or ($current.IsMenuCurrent "main" .) ($current.HasMenuCurrent "main" .) }}
        {{ $isProducts := eq .Identifier "products" }}
        <li class="{{ if .HasChildren }}has-dropdown{{ end }}{{ if $isProducts }} has-mega{{ end }}">
          <a href="{{ .URL | relLangURL }}" class="{{ if $active }}is-active{{ end }}">
            <span>{{ .Name }}</span>
            {{ if .HasChildren }}
            <svg class="dropdown-arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"
              aria-hidden="true">
              <path fill-rule="evenodd"
                d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z"
                clip-rule="evenodd" />
            </svg>
            {{ end }}
          </a>

          {{ if .HasChildren }}
          {{ if $isProducts }}
          <div class="mega-menu" aria-label="Products submenu">
            <div class="mega-menu__inner container container--wide">
              <div class="mega-menu__grid">
              {{ range .Children }}
              {{ $group := . }}
              {{ $groupActive := or ($current.IsMenuCurrent "main" $group) ($current.HasMenuCurrent "main" $group) }}
              <div class="mega-menu__group">
                {{ $groupHasUrl := $group.URL }}
                <div class="mega-menu__title-wrapper">
                  {{ if $groupHasUrl }}
                  <a href="{{ $group.URL | relLangURL }}" class="mega-menu__title {{ if $groupActive }}is-active{{ end }}">{{ $group.Name }}</a>
                  {{ else }}
                  <span class="mega-menu__title">{{ $group.Name }}</span>
                  {{ end }}
                </div>
                {{ if $group.HasChildren }}
                {{ $isStyleGroup := eq $group.Identifier "products-style" }}
                <ul class="mega-menu__list{{ if $isStyleGroup }} mega-menu__list--single{{ end }}">
                  {{ range $group.Children }}
                  {{ $itemActive := or ($current.IsMenuCurrent "main" .) ($current.HasMenuCurrent "main" .) }}
                  <li>
                    <a href="{{ .URL | relLangURL }}" class="{{ if $itemActive }}is-active{{ end }}">{{ .Name }}</a>
                  </li>
                  {{ end }}
                </ul>
                {{ end }}
              </div>
              {{ end }}
              </div>
            </div>
          </div>
          {{ else }}
          <ul class="dropdown-menu">
            {{ range .Children }}
            {{ $childActive := or ($current.IsMenuCurrent "main" .) ($current.HasMenuCurrent "main" .) }}
            <li>
              <a href="{{ .URL | relLangURL }}" class="{{ if $childActive }}is-active{{ end }}">{{ .Name }}</a>
            </li>
            {{ end }}
          </ul>
          {{ end }}
          {{ end }}
        </li>
        {{ end }}
      </ul>
    </nav>

    <div class="navbar__actions">
      {{ if hugo.IsMultilingual }}
      <div class="lang-switcher">
        <button class="lang-switcher__button">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="1.5"
            stroke="currentColor" aria-hidden="true" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"></circle>
            <path d="M2 12h20"></path>
            <path d="M12 2a15.75 15.75 0 0 1 0 20"></path>
            <path d="M12 2a15.75 15.75 0 0 0 0 20"></path>
          </svg>
          <span>{{ .Site.Language.LanguageName }}</span>
        </button>
        <div class="lang-switcher__dropdown">
          {{ range .Site.Home.AllTranslations }}
          {{ if ne .Language.Lang $.Site.Language.Lang }}
          <a href="{{ .RelPermalink }}">{{ .Language.LanguageName }}</a>
          {{ end }}
          {{ end }}
        </div>
      </div>
      {{ end }}

      <button class="navbar__toggler" id="drawer-toggler"
        aria-label="{{ i18n "mobile_menu_open" | default "Open menu" }}" aria-expanded="false"
        aria-controls="drawer"
        data-open-label="{{ i18n "mobile_menu_open" | default "Open menu" }}"
        data-close-label="{{ i18n "mobile_menu_close" | default "Close menu" }}">
        <span class="toggler-bar"></span>
        <span class="toggler-bar"></span>
        <span class="toggler-bar"></span>
      </button>
    </div>
  </nav>
</header>

<div class="drawer-overlay" id="drawer-overlay"></div>
<aside class="drawer" id="drawer" aria-hidden="true">
  <div class="drawer__top">
    <button class="drawer__back" id="drawer-back" type="button"
      aria-label="{{ i18n "mobile_menu_back" | default "Back" }}" hidden>
      <svg class="drawer__icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"
        aria-hidden="true">
        <path fill-rule="evenodd"
          d="M12.78 15.78a.75.75 0 01-1.06 0l-4.5-4.5a.75.75 0 010-1.06l4.5-4.5a.75.75 0 111.06 1.06L8.81 10l3.97 3.97a.75.75 0 010 1.06z"
          clip-rule="evenodd" />
      </svg>
    </button>
    <span class="drawer__title" id="drawer-title"
      data-root-title="{{ i18n "mobile_menu_title" | default "Menu" }}">{{ i18n "mobile_menu_title" | default "Menu" }}</span>
  </div>

  <nav class="drawer__menu" id="drawer-menu" aria-label="Mobile navigation"></nav>

  {{ if hugo.IsMultilingual }}
  <div class="drawer__languages" id="drawer-languages">
    <button class="drawer__languages-toggle" id="drawer-languages-toggle" type="button" aria-expanded="false"
      aria-controls="drawer-language-list">
      <span>{{ i18n "mobile_menu_language" | default "Languages" }}</span>
      <svg class="drawer__icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"
        aria-hidden="true">
        <path fill-rule="evenodd"
          d="M5.23 7.21a.75.75 0 011.06.02L10 11.17l3.71-3.94a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z"
          clip-rule="evenodd" />
      </svg>
    </button>
    <ul class="drawer__languages-list" id="drawer-language-list">
      {{ range .Site.Home.AllTranslations }}
      {{ if eq .Language.Lang $.Site.Language.Lang }}
      <li class="is-active"><span>{{ .Language.LanguageName }}</span></li>
      {{ else }}
      <li><a href="{{ .RelPermalink }}">{{ .Language.LanguageName }}</a></li>
      {{ end }}
      {{ end }}
    </ul>
  </div>
  {{ end }}
</aside>

{{- $mobileMenuData := slice -}}
{{- $currentPage := . -}}
{{- range .Site.Menus.main -}}
  {{- $mobileMenuData = $mobileMenuData | append (partial "mobile-menu-node.html" (dict "Item" . "Current" $currentPage)) -}}
{{- end -}}
<script type="application/json" id="mobile-menu-data">{{ $mobileMenuData | jsonify | safeHTML }}</script>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const header = document.getElementById('site-header');
    const body = document.body;
    const bodyHiddenClass = 'header-hidden';

    // --- 1. 智能导航栏 (Smart Header) 逻辑 ---
    if (header) {
      let lastScrollY = window.scrollY;     // 上一次滚动位置
      const scrollThreshold = 72;         // 超过导航栏高度后才开始隐藏/显示
      const scrollDelta = 5;             // 滚动变化小于 5px 时不处理，防止抖动

      function handleSmartHeader() {
        const currentScrollY = window.scrollY;

        // 1. 处理 'is-scrolled' 样式 (背景/阴影变化)
        if (currentScrollY > 10) header.classList.add('is-scrolled');
        else header.classList.remove('is-scrolled');

        // 2. 处理 'is-hidden' 样式 (隐藏/显示)
        // 在页面顶部时，始终显示导航栏
        if (currentScrollY <= scrollThreshold) {
          header.classList.remove('is-hidden');
          body.classList.remove(bodyHiddenClass);
          lastScrollY = currentScrollY;
          return;
        }

        // 滚动变化不大时忽略
        if (Math.abs(lastScrollY - currentScrollY) < scrollDelta) {
          return;
        }

        // 向上滚动 (显示)
        if (currentScrollY < lastScrollY) {
          header.classList.remove('is-hidden');
          body.classList.remove(bodyHiddenClass);
        }
        // 向下滚动 (隐藏)
        else if (currentScrollY > lastScrollY) {
          header.classList.add('is-hidden');
          body.classList.add(bodyHiddenClass);
        }

        // 更新上一次滚动位置
        lastScrollY = currentScrollY;
      }

      // 使用 requestAnimationFrame 优化滚动性能
      let ticking = false;
      window.addEventListener('scroll', () => {
        if (!ticking) {
          window.requestAnimationFrame(() => {
            handleSmartHeader();
            ticking = false;
          });
          ticking = true;
        }
      });

      // 页面加载时执行一次
      handleSmartHeader();
    }

    // --- 2. 抽屉 (Drawer) 逻辑 ---
    const drawer = document.getElementById('drawer');
    const drawerMenu = document.getElementById('drawer-menu');
    const drawerTitle = document.getElementById('drawer-title');
    const drawerBack = document.getElementById('drawer-back');
    const drawerLanguages = document.getElementById('drawer-languages');
    const drawerLanguagesToggle = document.getElementById('drawer-languages-toggle');
    const drawerLanguageList = document.getElementById('drawer-language-list');
    const drawerToggler = document.getElementById('drawer-toggler');
    const drawerOverlay = document.getElementById('drawer-overlay');
    const menuDataElement = document.getElementById('mobile-menu-data');

    const rootTitle = drawerTitle ? (drawerTitle.dataset.rootTitle || drawerTitle.textContent.trim()) : '';
    const menuData = menuDataElement ? JSON.parse(menuDataElement.textContent) : [];
    const openLabel = drawerToggler ? (drawerToggler.dataset.openLabel || drawerToggler.getAttribute('aria-label') || 'Open menu') : 'Open menu';
    const closeLabel = drawerToggler ? (drawerToggler.dataset.closeLabel || 'Close menu') : 'Close menu';

    let menuStack = [];

    const collapseLanguages = () => {
      if (drawerLanguagesToggle) {
        drawerLanguagesToggle.setAttribute('aria-expanded', 'false');
      }
      if (drawerLanguageList) {
        drawerLanguageList.classList.remove('is-open');
      }
    };

    const createChevronIcon = () => {
      const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
      svg.setAttribute('class', 'drawer__icon');
      svg.setAttribute('viewBox', '0 0 20 20');
      svg.setAttribute('fill', 'currentColor');
      svg.setAttribute('aria-hidden', 'true');
      const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
      path.setAttribute('fill-rule', 'evenodd');
      path.setAttribute('clip-rule', 'evenodd');
      path.setAttribute('d', 'M7.22 4.22a.75.75 0 011.06 0l4.5 4.5a.75.75 0 010 1.06l-4.5 4.5a.75.75 0 01-1.06-1.06L10.19 10 7.22 7.03a.75.75 0 010-1.06z');
      svg.appendChild(path);
      return svg;
    };

    const renderMenu = () => {
      if (!drawerMenu) return;
      const currentLevel = menuStack[menuStack.length - 1] || { items: [] };
      const items = Array.isArray(currentLevel.items) ? currentLevel.items : [];
      const title = currentLevel.title || rootTitle;

      drawerMenu.innerHTML = '';

      if (drawerTitle) {
        drawerTitle.textContent = title;
      }

      if (drawerBack) {
        const hasParent = menuStack.length > 1;
        drawerBack.hidden = !hasParent;
        drawerBack.setAttribute('aria-hidden', hasParent ? 'false' : 'true');
      }

      const list = document.createElement('ul');
      list.className = 'drawer__list';

      items.forEach((item) => {
        const listItem = document.createElement('li');
        const row = document.createElement('div');
        row.className = 'drawer__item-row';

        const linkText = item && item.name ? item.name : '';
        const hasChildren = item && Array.isArray(item.children) && item.children.length > 0;
        const isActive = Boolean(item && item.active);

        if (item && item.url) {
          const link = document.createElement('a');
          link.className = 'drawer__link';
          link.href = item.url;
          link.textContent = linkText;
          if (isActive) {
            link.classList.add('is-active');
            row.classList.add('is-active');
          }
          row.appendChild(link);
        } else {
          const label = document.createElement('span');
          label.className = 'drawer__link';
          label.textContent = linkText;
          if (isActive) {
            label.classList.add('is-active');
            row.classList.add('is-active');
          }
          row.appendChild(label);
        }

        if (hasChildren) {
          const toggle = document.createElement('button');
          toggle.type = 'button';
          toggle.className = 'drawer__child-toggle';
          toggle.setAttribute('aria-label', linkText);
          toggle.setAttribute('aria-haspopup', 'true');
          toggle.setAttribute('aria-expanded', 'false');
          if (linkText) {
            toggle.setAttribute('title', linkText);
          }
          toggle.appendChild(createChevronIcon());
          toggle.addEventListener('click', (event) => {
            event.preventDefault();
            event.stopPropagation();
            menuStack.push({ title: linkText, items: item.children });
            collapseLanguages();
            renderMenu();
          });
          row.appendChild(toggle);
        }

        listItem.appendChild(row);
        list.appendChild(listItem);
      });

      drawerMenu.appendChild(list);

      if (drawerLanguages) {
        const atRoot = menuStack.length === 1;
        drawerLanguages.hidden = !atRoot;
        if (!atRoot) {
          collapseLanguages();
        } else if (drawerLanguagesToggle) {
          const expanded = drawerLanguageList && drawerLanguageList.classList.contains('is-open');
          drawerLanguagesToggle.setAttribute('aria-expanded', expanded ? 'true' : 'false');
        }
      }
    };

    const resetMenuStack = () => {
      menuStack = [{ title: rootTitle || '', items: menuData }];
    };

    const openDrawer = () => {
      resetMenuStack();
      collapseLanguages();
      renderMenu();
      body.setAttribute('data-drawer-open', 'true');
      if (drawer) {
        drawer.setAttribute('aria-hidden', 'false');
      }
      if (drawerToggler) {
        drawerToggler.classList.add('open');
        drawerToggler.setAttribute('aria-expanded', 'true');
        drawerToggler.setAttribute('aria-label', closeLabel);
      }
    };

    const closeDrawer = () => {
      body.setAttribute('data-drawer-open', 'false');
      if (drawer) {
        drawer.setAttribute('aria-hidden', 'true');
      }
      if (drawerToggler) {
        drawerToggler.classList.remove('open');
        drawerToggler.setAttribute('aria-expanded', 'false');
        drawerToggler.setAttribute('aria-label', openLabel);
      }
      resetMenuStack();
      collapseLanguages();
      renderMenu();
    };

    resetMenuStack();
    renderMenu();

    if (drawerToggler) {
      drawerToggler.addEventListener('click', () => {
        const isOpen = body.getAttribute('data-drawer-open') === 'true';
        if (isOpen) {
          closeDrawer();
        } else {
          openDrawer();
        }
      });
    }

    if (drawerOverlay) {
      drawerOverlay.addEventListener('click', closeDrawer);
    }

    if (drawerBack) {
      drawerBack.addEventListener('click', () => {
        if (menuStack.length > 1) {
          menuStack.pop();
          renderMenu();
        }
      });
    }

    if (drawerMenu) {
      drawerMenu.addEventListener('click', (event) => {
        const target = event.target instanceof Element ? event.target.closest('a') : null;
        if (target && body.getAttribute('data-drawer-open') === 'true') {
          closeDrawer();
        }
      });
    }

    if (drawerLanguagesToggle && drawerLanguageList) {
      drawerLanguagesToggle.addEventListener('click', () => {
        const expanded = drawerLanguagesToggle.getAttribute('aria-expanded') === 'true';
        const nextState = !expanded;
        drawerLanguagesToggle.setAttribute('aria-expanded', nextState ? 'true' : 'false');
        drawerLanguageList.classList.toggle('is-open', nextState);
      });
    }

    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape' && body.getAttribute('data-drawer-open') === 'true') {
        closeDrawer();
      }
    });
  });
</script>
